# [Project]sparkify会员用户流失预测

sparkify是一个类似于网易云音乐、QQ音乐等提供数字音乐服务的平台。用户类型有带广告的免费用户、会员用户。会员用户每月支付固定费用免费听歌。任何时候，用户可以自己升级为会员用户或者降级为免费用户。用户的每次操作，例如播放歌曲、点赞、登录、登出、升级、降级等都会产生数据，这些数据包含了能让用户满意并帮助sparkify业务蓬勃发展的关键信息。数据集来源于Udacity，完整的数据集大小为12GB。

本项目基于完整数据集的一个子集，大小为231MB，预测哪些用户从会员降级为免费，或者直接取消服务了。如果在用户离开之前，可以精确识别到这些用户，sparkify可以通过给用户打折或者其他激励方式留住用户，这样就可以挽救数百位的营业额。

## 解决方案
项目目标是要在用户离开之前，精确识别这些用户，通过打折或者其他激励措施留着用户，挽救营业额。通过历史数据，预测用户继续付费使用sparkify，还是流失，这是二元分类问题。具体解决思路如下：
+ **paid用户才会为sparkify带来营业额，所以首先需要过滤掉免费用户**
+ 根据用户路径，定义执行Submit Downgrade或者Cancellation Confirmation操作的用户为流失用户
+ 数据清理，处理数据集中数据缺失、异常值和数据格式问题
+ 数据集探索，对比会员用户与流失用户的行为，找出用户流失的潜在规律
+ 建模，使用机器学习中的分类模型，如SVM、决策树等，训练数据
+ 预测，使用训练好的模型，预测用户

## 评价指标
目标是找到流失用户，通过打折或者其他激励留住这些用户，另外把会员用户误识别为流失用户是有害的，因为打折或者激励会造成不必要的损失。使用F1 score作为评价指标，同时考虑精确率和召回率

## 运行环境
+ Spark 2.4.5
+ Scala 2.11
	
## 数据集
数据集来源于Udacity， 是完整数据集的一个子集，231MB。各字段含义如下：
+ artist: 		string, 歌手
+ auth: 		string, 登录状态
+ firstName: 		string, 用户名
+ gender: 		string, 用户性别
+ itemInSession: 	long, 	页面停留时间，单位秒
+ lastName: 		string, 用户姓
+ length: 		double, 听歌时长，单位秒
+ level: 		string, 用户类型，paid或者free
+ location: 		string, 地理位置
+ method: 		string, 页面请求，PUT or GET
+ page:			string, 用户访问页面
+ registration: 	long, 	注册时间, 从epoch开始的秒数
+ sessionId:		long, 	与服务器会话的ID
+ song:			string, 歌曲名称
+ status:		long,	页面请求状态码，例如200表示成功返回网页，404表示页面不存在
+ ts:			long,	事件发生时间，从epoch开始的秒数
+ userAgent:		string, 用户使用的终端
+ userId:		string, 用户ID，唯一


## 结论   
本文根据sparkify的子集，研究了流失用户的特征，并根据此特征建立了决策树模型。调优后的模型在测试集的f1 score为0.5674。  
首先进行了数据清理，丢弃缺失数据行，并转换了日期格式；然后数据可视化探索，对比会员用户和流失用户的行为差异。一个值得注意的地方是，流失用户更加活跃，无论是从注册以来活跃天数的比例，还是最近两周听歌的数量、最近两周活跃的天数，都比现有会员用户高。可能的原因是活跃度高的用户对sparkify的用户体验要求更高。因为经常使用，一些设计瑕疵会严重影响用户体验，导致用户流失。这点需要在更大的数据集上验证。  
调优后的决策树模型虽然有了提升，但实际上比天真预测器还要差些。原因是数据集太小了，只是完整数据集的1.8%，测试集数据量就更小，只有26个用户。预测数量上增加一个或者减少一个，会极大的影响评估指标。所以下一步改进的方向是在更大的数据集训练和调优模型。